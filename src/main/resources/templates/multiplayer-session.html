<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Совместное прохождение</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            padding: 30px;
        }

        .session-card {
            background: white;
            width: 420px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 32px 36px;
            text-align: center;
        }

        .session-card h2 {
            font-size: 1.4rem;
            color: #555;
            margin-bottom: 12px;
        }

        .quiz-title {
            font-size: 1.9rem;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .session-link {
            display: inline-block;
            margin: 12px 0 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .session-link:hover {
            text-decoration: underline;
        }

        .participants-box {
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 28px;
            background: #f8f9fa;
        }

        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: #666;
            font-size: 0.95rem;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        .participant {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4c51bf;
            font-weight: bold;
            font-size: 18px;
        }

        .empty-seat {
            background: #f1f5f9;
            color: #94a3b8;
            font-weight: normal;
        }

        .primary-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.35);
        }

        .cancel-link {
            display: inline-block;
            margin-top: 18px;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .cancel-link:hover {
            text-decoration: underline;
            color: #6b7280;
        }

        .status {
            margin-top: 18px;
            color: #6b7280;
            font-size: 0.95rem;
        }

        .copy-feedback {
            margin-top: 8px;
            color: #16a34a;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>
<body>
<div class="session-card">
    <h2>Совместное прохождение</h2>
    <div class="quiz-title" id="quizName" th:text="${quizName != null ? quizName : 'Название Квиза'}" th:attr="data-quiz-id=${quizId}">Название Квиза</div>
    <button class="session-link" id="sessionLink" type="button" onclick="copySessionLink(event)" style="background: none; border: none; color: #667eea; text-decoration: none; font-weight: 500; cursor: pointer; padding: 0; margin: 12px 0 20px; display: inline-block;">Скопировать ссылку на сессию</button>
    <div class="copy-feedback" id="copyFeedback">Ссылка скопирована!</div>

    <div class="participants-box">
        <div class="participants-header">
            <span>Участники</span>
            <span id="participantCount">0/10</span>
        </div>
        <div class="participants-grid" id="participantsGrid">
            <!-- Заполняется скриптом -->
        </div>
    </div>

    <button class="primary-btn" id="startSessionBtn" onclick="startSession()" th:if="${currentUserId != null and hostUserId != null and currentUserId == hostUserId}">
        ▶ Начать
    </button>

    <a class="cancel-link" onclick="cancelSession()">Отменить</a>

    <div class="status" id="sessionStatus" th:text="${(currentUserId != null and hostUserId != null and currentUserId == hostUserId) ? 'Ожидание подключения участников...' : 'Ожидание начала квиза'}">
        Ожидание подключения участников...
    </div>
    <div th:if="${errorMessage != null}" class="error-message" style="background-color: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-top: 15px;" th:text="${errorMessage}"></div>
</div>

<script>
    let SESSION_ID = null;
    let HOST_USER_ID = Number(localStorage.getItem('userId')) || 1;
    const MAX_PARTICIPANTS = 10;
    const API_BASE = '/api/multiplayer';
    
    (function() {
        const sessionIdFromModel = /*[[${sessionId}]]*/ null;
        const hostUserIdFromModel = /*[[${hostUserId}]]*/ null;
        
        if (sessionIdFromModel) {
            SESSION_ID = sessionIdFromModel;
        }
        if (hostUserIdFromModel) {
            HOST_USER_ID = Number(hostUserIdFromModel);
        }
    })();
    
    if (!SESSION_ID || SESSION_ID === 'null' || SESSION_ID === null) {
        const pathMatch = window.location.pathname.match(/\/multiplayer\/session\/([^\/\?]+)/);
        if (pathMatch && pathMatch[1]) {
            SESSION_ID = pathMatch[1];
            console.log('SESSION_ID extracted from URL:', SESSION_ID);
        } else {
            console.error('SESSION_ID not found in template or URL');
        }
    }
    
    console.log('SESSION_ID final value:', SESSION_ID);
    console.log('HOST_USER_ID final value:', HOST_USER_ID);

     // Заголовок, если нужно поменять динамически
     // document.getElementById('quizName').textContent = `Квиз: ${window.initialQuizTitle}`;

    function renderParticipants(participants) {
        const grid = document.getElementById('participantsGrid');
        grid.innerHTML = '';
        const totalSpots = MAX_PARTICIPANTS;

        for (let i = 0; i < totalSpots; i++) {
            const slot = document.createElement('div');
            if (participants[i]) {
                const initials = participants[i].username
                    .split(' ')
                    .map(word => word[0]?.toUpperCase())
                    .join('');
                slot.textContent = initials || 'U';
                slot.title = participants[i].username;
                slot.className = 'participant';
            } else {
                slot.textContent = '+';
                slot.className = 'participant empty-seat';
                slot.title = 'Свободное место';
            }
            grid.appendChild(slot);
        }

        document.getElementById('participantCount').textContent =
           `${participants.length}/${MAX_PARTICIPANTS}`;
    }

    async function fetchSession() {
        if (!SESSION_ID || SESSION_ID === 'null' || SESSION_ID === 'abc123xyz' || SESSION_ID === null) {
            const errorMsg = 'Ошибка: ID сессии не найден. SESSION_ID=' + SESSION_ID + ' (type: ' + typeof SESSION_ID + ')';
            console.error(errorMsg);
            console.error('Available in model:', {
                sessionId: /*[[${sessionId}]]*/ 'not set',
                hostUserId: /*[[${hostUserId}]]*/ 'not set'
            });
            document.getElementById('sessionStatus').textContent = errorMsg;
            return;
        }
        
        try {
            const url = `${API_BASE}/sessions/${SESSION_ID}`;
            console.log('Fetching session from:', url);
            console.log('SESSION_ID:', SESSION_ID);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text().catch(() => '');
                console.error('Error response:', response.status, errorText);
                throw new Error(`Сервер вернул ${response.status}`);
            }

            const session = await response.json();
            console.log('Session loaded:', session);
            document.getElementById('quizName').textContent = session.quizName;
            renderParticipants(session.participants || []);
            
            const currentUserId = Number(localStorage.getItem('userId'));
            const hostUserId = HOST_USER_ID;
            const isHost = currentUserId && hostUserId && currentUserId === hostUserId;
            
            if (isHost) {
                document.getElementById('sessionStatus').textContent =
                    `Статус: ${translateStatus(session.status)}`;
            } else {
                if (session.status === 'STARTED') {
                    document.getElementById('sessionStatus').textContent = 'Квиз начался!';
                } else {
                    document.getElementById('sessionStatus').textContent = 'Ожидание начала квиза';
                }
            }
        } catch (error) {
            console.error('Error fetching session:', error);
            document.getElementById('sessionStatus').textContent =
                `Не удалось загрузить данные сессии: ${error.message}`;
        }
     }
    async function startSession() {
        try {
            const response = await fetch(`${API_BASE}/sessions/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    sessionId: SESSION_ID,
                    hostUserId: HOST_USER_ID
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                const errorMessage = error.message || (response.status === 400 ? 'Нельзя начать мультиплеер одному. Нужно минимум 2 участника.' : `Сервер вернул ${response.status}`);
                throw new Error(errorMessage);
            }

            const currentUserId = Number(localStorage.getItem('userId'));
            const hostUserId = HOST_USER_ID;
            const isHost = currentUserId && hostUserId && currentUserId === hostUserId;
            
            if (isHost) {
                document.getElementById('sessionStatus').textContent = 'Сессия запущена';
            } else {
                document.getElementById('sessionStatus').textContent = 'Квиз начался!';
            }
        } catch (error) {
            document.getElementById('sessionStatus').textContent = error.message;
        }
    }
    async function cancelSession() {
        const currentUserId = Number(localStorage.getItem('userId'));
        const hostUserId = HOST_USER_ID;
        const isHost = currentUserId && hostUserId && currentUserId === hostUserId;
        
        try {
            if (isHost) {
                // Хост отменяет сессию
                const response = await fetch(`${API_BASE}/sessions/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        sessionId: SESSION_ID,
                        hostUserId: HOST_USER_ID
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.message || `Сервер вернул ${response.status}`);
                }
            } else {
                // Участник выходит из сессии
                const response = await fetch(`${API_BASE}/sessions/${SESSION_ID}/leave?userId=${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.message || `Сервер вернул ${response.status}`);
                }
            }

            window.location.href = '/home';
        } catch (error) {
            console.error('Error canceling/leaving session:', error);
            window.location.href = '/home';
        }
    }
    function translateStatus(status) {
        switch (status) {
            case 'WAITING': return 'ожидание участников';
            case 'STARTED': return 'идёт прохождение';
            case 'FINISHED': return 'завершена';
            case 'CANCELLED': return 'отменена';
            default: return status;
        }
    }
    
    function copySessionLink(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        let currentSessionId = SESSION_ID;
        console.log('copySessionLink: initial SESSION_ID =', currentSessionId);
        
        if (!currentSessionId || currentSessionId === 'null' || currentSessionId === 'abc123xyz' || currentSessionId === null) {
            const pathMatch = window.location.pathname.match(/\/multiplayer\/session\/([^\/\?]+)/);
            if (pathMatch && pathMatch[1]) {
                currentSessionId = pathMatch[1];
                console.log('SESSION_ID extracted from URL for copy:', currentSessionId);
            } else {
                console.error('SESSION_ID not found in URL or variable');
                alert('Ошибка: ID сессии не найден. Пожалуйста, обновите страницу.');
                return;
            }
        }
        
        const userId = localStorage.getItem('userId') || HOST_USER_ID;
        const linkText = window.location.origin + '/multiplayer/join?sessionId=' + currentSessionId + '&userId=' + userId;
        
        console.log('Copying link:', linkText);
        console.log('SESSION_ID used:', currentSessionId);
        console.log('userId used:', userId);
        
        const feedback = document.getElementById('copyFeedback');
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(linkText).then(() => {
                console.log('Successfully copied to clipboard');
                if (feedback) {
                    feedback.style.display = 'block';
                    setTimeout(() => {
                        feedback.style.display = 'none';
                    }, 2000);
                }
            }).catch((err) => {
                console.error('Failed to copy to clipboard:', err);
                fallbackCopyTextToClipboard(linkText, feedback);
            });
        } else {
            console.log('Clipboard API not available, using fallback');
            fallbackCopyTextToClipboard(linkText, feedback);
        }
    }
    
    function fallbackCopyTextToClipboard(text, feedbackElement) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                console.log('Fallback: Copying text command was successful');
                if (feedbackElement) {
                    feedbackElement.style.display = 'block';
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 2000);
                }
            } else {
                console.error('Fallback: Unable to copy');
                prompt('Скопируйте ссылку вручную:', text);
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            prompt('Скопируйте ссылку вручную:', text);
        } finally {
            document.body.removeChild(textArea);
        }
    }

    fetchSession();

    let pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`${API_BASE}/sessions/${SESSION_ID}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (!response.ok) return;

            const session = await response.json();
            renderParticipants(session.participants || []);
            const currentUserId = Number(localStorage.getItem('userId'));
            const hostUserId = HOST_USER_ID;
            const isHost = currentUserId && hostUserId && currentUserId === hostUserId;
            
            if (isHost) {
                document.getElementById('sessionStatus').textContent =
                    `Статус: ${translateStatus(session.status)}`;
            } else {
                if (session.status === 'STARTED') {
                    document.getElementById('sessionStatus').textContent = 'Квиз начался!';
                } else {
                    document.getElementById('sessionStatus').textContent = 'Ожидание начала квиза';
                }
            }

            if (session.status === 'STARTED') {
                clearInterval(pollInterval);
                const userId = localStorage.getItem('userId') || HOST_USER_ID;
                const quizIdElement = document.querySelector('[data-quiz-id]');
                const quizId = quizIdElement ? quizIdElement.getAttribute('data-quiz-id') : null;
                if (quizId) {
                    window.location.href = `/quiz/${quizId}/attempt?userId=${userId}&sessionId=${SESSION_ID}`;
                } else {
                    window.location.href = `/home`;
                }
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 2000);

    window.addEventListener('beforeunload', () => {
        clearInterval(pollInterval);
    });

</script>
</body>
</html>